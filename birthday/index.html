<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Gareth‚Äôs 28th ‚Äî Scratch to Reveal!</title>
    <meta name="theme-color" content="#0f172a" />
    <style>
      :root {
        --bg: #0f172a; /* slate-900 */
        --bg2: #1e293b; /* slate-800 */
        --card: #0b1220f2;
        --accent: #e879f9; /* fuchsia-400 */
        --accent-2: #60a5fa; /* blue-400 */
        --accent-3: #34d399; /* emerald-400 */
        --text: #e5e7eb; /* gray-200 */
        --muted: #94a3b8; /* slate-400 */
        --shadow: 0 10px 35px rgba(0,0,0,.35), 0 2px 10px rgba(0,0,0,.25);
      }

      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        color: var(--text);
        font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: radial-gradient(1200px 800px at 10% 10%, #1e293b 0%, #0f172a 55%, #0b1020 100%);
        display: grid;
        place-items: center;
        padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      }

      .wrap {
        width: min(92vw, 520px);
        padding: 20px 18px 24px;
        background: linear-gradient(180deg, rgba(17,24,39,.85), rgba(2,6,23,.85));
        border: 1px solid rgba(255,255,255,.06);
        border-radius: 18px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(6px);
      }

      header {
        display: grid;
        gap: 6px;
        margin: 0 4px 14px;
        text-align: center;
      }
      header h1 {
        margin: 0;
        font-size: clamp(22px, 5vw, 28px);
        font-weight: 800;
        letter-spacing: 0.2px;
        background: linear-gradient(90deg, var(--accent), var(--accent-2), var(--accent-3));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }
      header p {
        margin: 0;
        color: var(--muted);
        font-size: 0.98rem;
      }

      .card {
        position: relative;
        overflow: hidden;
        border-radius: 14px;
        background: #070b14;
        border: 1px solid rgba(255,255,255,.08);
        box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      }

      .reveal {
        position: relative;
        width: 100%;
        /* The height will follow the image ratio once loaded */
        aspect-ratio: 4 / 3; /* sensible default while loading */
        display: grid;
        place-items: center;
        background: repeating-conic-gradient(from 45deg, #0f172a, #0f172a 10deg, #0b1220 10deg, #0b1220 20deg);
      }

      .reveal img {
        width: 100%;
        height: auto;
        display: block;
        user-select: none;
        -webkit-user-drag: none;
        pointer-events: none;
      }

      canvas#scratch {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        touch-action: none; /* important for mobile */
      }

      .hint {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
        pointer-events: none;
        display: grid;
        place-items: center;
        gap: 6px;
        text-align: center;
        color: rgba(255,255,255,.9);
        text-shadow: 0 1px 2px rgba(0,0,0,.35);
      }
      .hint .hand {
        width: 38px;
        height: 38px;
        opacity: .9;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,.4));
        animation: wiggle 1.8s ease-in-out infinite;
      }
      @keyframes wiggle {
        0%,100% { transform: translate(-50%, -50%) rotate(-6deg); }
        50% { transform: translate(-50%, -50%) rotate(6deg); }
      }

      .toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-top: 12px;
        padding: 0 4px;
        color: var(--muted);
        font-size: 0.95rem;
      }

      .btn {
        appearance: none;
        border: 0;
        padding: 10px 14px;
        border-radius: 12px;
        background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
        color: var(--text);
        font-weight: 600;
        letter-spacing: .2px;
        cursor: pointer;
        box-shadow: 0 2px 0 rgba(255,255,255,.08) inset, 0 1px 0 rgba(0,0,0,.4);
        transition: transform .12s ease, filter .2s ease, background .2s ease;
      }
      .btn:hover { filter: brightness(1.06); }
      .btn:active { transform: translateY(1px) scale(.99); }

      .celebrate {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        pointer-events: none;
        opacity: 0;
        transition: opacity .35s ease;
      }
      .celebrate.show { opacity: 1; }
      .celebrate .badge {
        margin: 0;
        padding: 10px 14px;
        border-radius: 999px;
        background: rgba(2,6,23,.6);
        border: 1px solid rgba(255,255,255,.12);
        color: rgba(255,255,255,.92);
        text-shadow: 0 1px 2px rgba(0,0,0,.45);
        display: grid;
        place-items: center;
        gap: 6px;
      }
      .celebrate .badge .title {
        font-size: clamp(18px, 5vw, 26px);
        font-weight: 800;
        letter-spacing: .3px;
      }
      .celebrate .badge .from {
        font-size: clamp(14px, 3.5vw, 18px);
        font-weight: 700;
        letter-spacing: .2px;
      }

      /* Confetti */
      .confetti {
        position: absolute;
        inset: -10vh -10vw; /* allow offscreen start */
        overflow: hidden;
        pointer-events: none;
        z-index: 5;
      }
      .confetti i {
        position: absolute;
        top: -10vh;
        width: 10px; height: 14px;
        opacity: .9;
        transform: translate3d(0,0,0);
        animation: fall linear forwards;
      }
      @keyframes fall {
        to { transform: translate3d(var(--x, 0px), 110vh, 0) rotate(var(--rot, 0deg)); }
      }

      footer { margin-top: 16px; text-align: center; color: var(--muted); font-size: .9rem; }
      footer small { opacity: .8; }

      /* Reduce motion */
      @media (prefers-reduced-motion: reduce) {
        .hint .hand { animation: none; }
        .confetti i { animation-duration: 0.01ms; animation-iteration-count: 1; }
      }
    </style>
  </head>
  <body>
    <div class="wrap" role="application" aria-label="Scratch card for Gareth‚Äôs 28th birthday">
      <header>
        <h1>Gareth‚Äôs 28th Birthday</h1>
        <p>Scratch the card to reveal your present!</p>
      </header>

      <section class="card" aria-live="polite">
        <div class="reveal" id="reveal">
          <img id="prize" src="present.png" alt="A special birthday present for Gareth" />
          <canvas id="scratch"></canvas>
          <div class="hint" id="hint">
            <svg class="hand" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M9.5 11.5V6.75a1.75 1.75 0 1 1 3.5 0v4.5M13 9.5V6.25a1.75 1.75 0 1 1 3.5 0V11M16.5 9.25V6.75a1.75 1.75 0 1 1 3.5 0v7.25a4.5 4.5 0 0 1-4.5 4.5H12a5 5 0 0 1-5-5v-1.5" stroke="white" stroke-width="1.6" stroke-linecap="round"/> 
            </svg>
            <div>Swipe or drag to scratch</div>
          </div>

          <div class="celebrate" id="celebrate" aria-hidden="true">
            <div class="badge" role="status" aria-live="polite">
              <div class="title">Happy 28th, Gareth! üéâ</div>
              <div class="from">Love from Rhys and Phoebe x</div>
            </div>
          </div>

          <div class="confetti" id="confetti" aria-hidden="true"></div>
        </div>
      </section>

      <div class="toolbar">
        <div id="progress">Revealed: <strong>0%</strong></div>
        <button class="btn" id="reset" type="button" aria-label="Reset scratch card">Reset</button>
      </div>

      <footer>
        <small>Tip: Bigger strokes reveal faster. Have fun! üíù</small>
      </footer>
    </div>

    <script>
      (function() {
        const img = document.getElementById('prize');
        const canvas = document.getElementById('scratch');
        const hint = document.getElementById('hint');
        const celebrate = document.getElementById('celebrate');
        const confetti = document.getElementById('confetti');
        const progressEl = document.getElementById('progress').querySelector('strong');
        const resetBtn = document.getElementById('reset');
        const reveal = document.getElementById('reveal');
        let hideCelebrateTimer = null;

        const ctx = canvas.getContext('2d');
        let drawing = false;
        let revealed = false;
        let last = null;
        let brush = 16; // will scale with DPR (smaller default)
        let dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

        function sizeToImage() {
          // Fit canvas to the displayed image size
          const rect = reveal.getBoundingClientRect();
          const width = Math.round(rect.width);
          const height = Math.round(rect.height);

          canvas.width = Math.floor(width * dpr);
          canvas.height = Math.floor(height * dpr);
          canvas.style.width = width + 'px';
          canvas.style.height = height + 'px';

          // Adjust brush size based on viewport
          // Smaller brush across devices
          const base = Math.max(12, Math.min(28, Math.round(width / 16)));
          brush = Math.round(base * dpr);

          paintCover();
        }

        function paintCover() {
          // Reset composite and paint a nice metallic-ish cover
          ctx.globalCompositeOperation = 'source-over';
          const w = canvas.width, h = canvas.height;
          const grad = ctx.createLinearGradient(0,0,w,h);
          grad.addColorStop(0, '#26324a');
          grad.addColorStop(.5, '#1a2235');
          grad.addColorStop(1, '#0f172a');
          ctx.fillStyle = grad;
          ctx.fillRect(0,0,w,h);

          // Add subtle sparkles
          const sparkleCount = Math.floor((w*h) / (140*140));
          for (let i=0;i<sparkleCount;i++) {
            const x = Math.random() * w;
            const y = Math.random() * h;
            const r = Math.random() * (6*dpr) + (2*dpr);
            const g = ctx.createRadialGradient(x,y,0, x,y,r);
            g.addColorStop(0,'rgba(255,255,255,.9)');
            g.addColorStop(1,'rgba(255,255,255,0)');
            ctx.fillStyle = g;
            ctx.beginPath();
            ctx.arc(x,y,r,0,Math.PI*2);
            ctx.fill();
          }

          // Cover label
          ctx.fillStyle = 'rgba(255,255,255,.08)';
          ctx.font = `${Math.round(24*dpr)}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText('Scratch Here', canvas.width/2, canvas.height/2);

          ctx.globalCompositeOperation = 'destination-out';
        }

        function line(from, to) {
          ctx.lineCap = 'round';
          ctx.lineJoin = 'round';
          ctx.lineWidth = brush * 2;
          ctx.beginPath();
          ctx.moveTo(from.x, from.y);
          ctx.lineTo(to.x, to.y);
          ctx.stroke();
        }

        function circle(p) {
          ctx.beginPath();
          ctx.arc(p.x, p.y, brush, 0, Math.PI*2);
          ctx.fill();
        }

        function getPoint(e) {
          const rect = canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) * dpr;
          const y = (e.clientY - rect.top) * dpr;
          return {x,y};
        }

        function handlePointerDown(e) {
          if (revealed) return;
          hint.style.display = 'none';
          canvas.setPointerCapture(e.pointerId);
          drawing = true;
          const p = getPoint(e);
          circle(p);
          last = p;
        }
        function handlePointerMove(e) {
          if (!drawing || revealed) return;
          const p = getPoint(e);
          line(last, p);
          last = p;
        }
        function handlePointerUp(e) {
          if (!drawing) return;
          drawing = false;
          last = null;
          // Check progress a bit after letting go
          requestAnimationFrame(checkProgressThrottled);
        }

        let lastCheck = 0;
        function checkProgressThrottled(ts) {
          const now = performance.now();
          if (now - lastCheck < 160) return; // throttle
          lastCheck = now;
          const percent = getRevealedPercent();
          progressEl.textContent = Math.round(percent) + '%';
          if (!revealed && percent >= 58) complete();
        }

        function getRevealedPercent() {
          try {
            const {width:w, height:h} = canvas;
            const sampleStep = Math.max(1, Math.floor(2 * dpr)); // sample grid for performance
            const data = ctx.getImageData(0,0,w,h).data;
            let transparent = 0, total = 0;
            for (let y=0; y<h; y+=sampleStep) {
              for (let x=0; x<w; x+=sampleStep) {
                const idx = ((y*w) + x) * 4 + 3; // alpha
                if (data[idx] === 0) transparent++;
                total++;
              }
            }
            return (transparent / total) * 100;
          } catch (e) {
            return 0;
          }
        }

        function complete() {
          revealed = true;
          // Fade the remaining cover
          canvas.style.transition = 'opacity .5s ease';
          canvas.style.opacity = '0';
          celebrate.classList.add('show');
          celebrate.setAttribute('aria-hidden', 'false');
          fireConfetti();
          if (navigator.vibrate) {
            try { navigator.vibrate([30, 20, 30]); } catch(e){}
          }

          // Hide the celebration pill after 3 seconds
          if (hideCelebrateTimer) clearTimeout(hideCelebrateTimer);
          hideCelebrateTimer = setTimeout(() => {
            celebrate.classList.remove('show');
            celebrate.setAttribute('aria-hidden', 'true');
            hideCelebrateTimer = null;
          }, 3000);
        }

        function reset() {
          revealed = false;
          progressEl.textContent = '0%';
          canvas.style.opacity = '1';
          celebrate.classList.remove('show');
          celebrate.setAttribute('aria-hidden', 'true');
          hint.style.display = '';
          paintCover();
          confetti.innerHTML = '';
          if (hideCelebrateTimer) { clearTimeout(hideCelebrateTimer); hideCelebrateTimer = null; }
        }

        // Confetti generator (CSS powered, lightweight)
        function fireConfetti() {
          const colors = ['#f87171', '#fb923c', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa', '#f472b6'];
          const pieces = Math.min(180, Math.max(80, Math.floor(canvas.width / 6)));
          const duration = 2200; // ms
          for (let i = 0; i < pieces; i++) {
            const el = document.createElement('i');
            const hue = colors[i % colors.length];
            const xStart = Math.random() * 100; // vw percent-ish
            const drift = (Math.random() * 60 - 30) + 'vw';
            const rot = (Math.random() * 720 - 360) + 'deg';
            const delay = Math.random() * 0.15 + 's';
            el.style.left = xStart + 'vw';
            el.style.background = hue;
            el.style.borderRadius = Math.random() > .5 ? '2px' : '50%';
            el.style.transform = 'translate3d(0,0,0)';
            el.style.setProperty('--x', drift);
            el.style.setProperty('--rot', rot);
            el.style.animationDuration = (duration/1000 + Math.random()*0.8) + 's';
            el.style.animationDelay = delay;
            confetti.appendChild(el);
          }
          // Auto clear later
          setTimeout(() => { confetti.innerHTML = ''; }, 4500);
        }

        // Responsive sizing when image loads and on resize
        function applyImageRatio() {
          if (!img.naturalWidth || !img.naturalHeight) return;
          const ratio = img.naturalWidth / img.naturalHeight;
          reveal.style.aspectRatio = `${img.naturalWidth} / ${img.naturalHeight}`;
        }

        img.addEventListener('load', () => {
          applyImageRatio();
          sizeToImage();
        });

        window.addEventListener('resize', () => {
          const previous = ctx.getImageData(0,0,canvas.width, canvas.height);
          sizeToImage();
          // After resize, re-cover to avoid artifacts
          paintCover();
        });

        // Pointer events
        canvas.addEventListener('pointerdown', handlePointerDown);
        canvas.addEventListener('pointermove', handlePointerMove);
        canvas.addEventListener('pointerup', handlePointerUp);
        canvas.addEventListener('pointercancel', handlePointerUp);
        canvas.addEventListener('pointerleave', handlePointerUp);

        // Check progress occasionally while moving
        canvas.addEventListener('pointermove', checkProgressThrottled);

        // Reset handler
        resetBtn.addEventListener('click', reset);

        // If image is cached, trigger load path
        if (img.complete) {
          applyImageRatio();
          sizeToImage();
        }

        // Keyboard accessibility: press Enter/Space to auto-complete
        canvas.setAttribute('tabindex', '0');
        canvas.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            if (!revealed) complete();
          }
        });
      })();
    </script>
  </body>
</html>
